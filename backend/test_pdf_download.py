#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF
"""

import os
import time
import logging
from selenium_config import (
    create_standard_chrome_options, 
    setup_pdf_download_script,
    test_pdf_download_setup
)
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def test_pdf_download():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF"""
    
    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    downloads_dir = os.path.join(os.getcwd(), "test_downloads")
    os.makedirs(downloads_dir, exist_ok=True)
    logger.info(f"üìÅ –ü–∞–ø–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: {downloads_dir}")
    
    # –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Chrome
    options = create_standard_chrome_options(downloads_dir)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥—Ä–∞–π–≤–µ—Ä
    try:
        driver_path = ChromeDriverManager().install()
        service = Service(driver_path)
        driver = webdriver.Chrome(service=service, options=options)
        logger.info("‚úÖ Chrome –¥—Ä–∞–π–≤–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º JavaScript –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF
        setup_pdf_download_script(driver)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        test_pdf_download_setup(driver)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å —Ä–µ–∞–ª—å–Ω—ã–º PDF —Å kad.arbitr.ru
        logger.info("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º PDF...")
        test_url = "https://kad.arbitr.ru/Document/Pdf/12345678-1234-1234-1234-123456789012/12345678-1234-1234-1234-123456789012/12345678-1234-1234-1234-123456789012.pdf"
        
        try:
            driver.get(test_url)
            time.sleep(5)
            
            current_url = driver.current_url
            logger.info(f"üìç –¢–µ–∫—É—â–∏–π URL: {current_url}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ PDF –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            if current_url == test_url:
                logger.info("‚úÖ PDF –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–¥–æ–ª–∂–µ–Ω –±—ã–ª —Å–∫–∞—á–∞—Ç—å—Å—è)")
            else:
                logger.warning(f"‚ö†Ô∏è PDF –æ—Ç–∫—Ä—ã–ª—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ: {current_url}")
                
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ PDF: {e}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        downloaded_files = os.listdir(downloads_dir)
        logger.info(f"üìÑ –°–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: {downloaded_files}")
        
        if downloaded_files:
            logger.info("‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω—ã!")
            for file in downloaded_files:
                file_path = os.path.join(downloads_dir, file)
                file_size = os.path.getsize(file_path)
                logger.info(f"   üìÑ {file} ({file_size} –±–∞–π—Ç)")
        else:
            logger.warning("‚ö†Ô∏è –§–∞–π–ª—ã –Ω–µ —Å–∫–∞—á–∞–ª–∏—Å—å")
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä–∞–π–≤–µ—Ä
        driver.quit()
        logger.info("‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")

if __name__ == "__main__":
    test_pdf_download()
